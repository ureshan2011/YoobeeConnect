<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Yoobee Connect ¬∑ Swipe</title>
<style>
  :root {
    --bg: #0f172a;
    --bg-soft: #101b37;
    --card: rgba(13, 23, 45, 0.82);
    --border: rgba(148, 163, 184, 0.18);
    --text: #f8fafc;
    --muted: #9ca3af;
    --acc: #38bdf8;
    --accent-soft: rgba(56, 189, 248, 0.12);
    --shadow: 0 25px 60px rgba(15, 23, 42, 0.45);
  }
  * { box-sizing: border-box; }
  body{
    margin:0;
    font-family:"Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background:radial-gradient(circle at 0% 0%, rgba(56,189,248,0.22), transparent 40%),
               radial-gradient(circle at 100% 0%, rgba(16,185,129,0.18), transparent 45%),
               linear-gradient(180deg, #0b1022 0%, #0f172a 60%, #0b162f 100%);
    color:var(--text);
    display:flex;
    min-height:100vh;
    align-items:center;
    justify-content:center;
    padding:32px;
  }
  .app{width:100%;max-width:760px;display:flex;flex-direction:column;gap:20px}
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:26px;
    padding:28px;
    box-shadow:var(--shadow);
    backdrop-filter:blur(16px);
  }
  h1{margin:0 0 8px;font-weight:700;letter-spacing:.2px;font-size:30px}
  .sub{color:var(--muted);margin:0 0 20px;font-size:16px;line-height:1.5}
  label{display:block;margin:12px 0 8px;color:#cbd5f5;font-size:14px;font-weight:600}
  input,select,textarea{
    width:100%;
    padding:12px 14px;
    border-radius:14px;
    border:1px solid rgba(148, 163, 184, 0.3);
    background:rgba(15, 23, 42, 0.65);
    color:var(--text);
    transition:border 0.2s, box-shadow 0.2s;
    font-size:15px;
  }
  input:focus,select:focus,textarea:focus{
    outline:none;
    border-color:rgba(56, 189, 248, 0.8);
    box-shadow:0 0 0 4px var(--accent-soft);
  }
  select{appearance:none;background-image:url('data:image/svg+xml,%3Csvg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M1.41 0.589844L6 5.16984L10.59 0.589844L12 1.99984L6 7.99984L0 1.99984L1.41 0.589844Z" fill="%23cbd5f5"/%3E%3C/svg%3E');background-repeat:no-repeat;background-position:right 14px center;background-size:12px}
  .row{display:flex;flex-wrap:wrap;gap:16px}
  .row > div{flex:1 1 240px;min-width:0}
  .btn{
    appearance:none;
    border:0;
    border-radius:14px;
    padding:12px 18px;
    background:rgba(15, 23, 42, 0.75);
    color:#e5f2ff;
    font-weight:650;
    cursor:pointer;
    transition:transform 0.15s ease, box-shadow 0.2s ease, background 0.2s;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 10px 25px rgba(15,23,42,0.35)}
  .btn.primary{background:linear-gradient(135deg,#06b6d4,#38bdf8);color:#0b1220}
  .btn.primary:hover{box-shadow:0 15px 30px rgba(56,189,248,0.4)}
  .btn.ghost{background:transparent;border:1px solid rgba(148, 163, 184, 0.35);color:#e2e8f0}
  .actions{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
  .deck{display:flex;gap:18px;align-items:stretch;margin-top:16px;flex-wrap:wrap}
  .profile{flex:1 1 300px;border:1px solid rgba(148,163,184,0.16);border-radius:20px;padding:20px;background:rgba(9,16,31,0.75);min-height:220px;display:flex;flex-direction:column;justify-content:space-between}
  .pill{display:inline-flex;align-items:center;gap:6px;background:rgba(56,189,248,0.16);border:1px solid rgba(56,189,248,0.35);border-radius:999px;padding:6px 12px;margin:4px 6px 0 0;color:#cde8ff;font-size:13px;font-weight:500}
  .badges{margin-top:10px;display:flex;flex-wrap:wrap}
  .foot{margin-top:16px;color:#93a3c7;font-size:14px;line-height:1.5}
  .hr{height:1px;background:rgba(148,163,184,0.14);margin:18px 0}
  .muted{color:#9ca3af}
  .center{display:flex;align-items:center;justify-content:center;text-align:center}
  .match{border:1px solid rgba(16,185,129,0.35);background:rgba(16,185,129,0.08);padding:16px;border-radius:16px;margin-top:16px;line-height:1.5}
  .swipe-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:4px 0 18px}
  .swipe-head h3{margin:0;font-size:22px;font-weight:650}
  .hint{font-size:13px;color:#a3b2d6;line-height:1.5}
  .tag-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .tag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    background:rgba(148, 163, 184, 0.1);
    color:#dbeafe;
    padding:8px 12px;
    border-radius:999px;
    font-size:13px;
    text-transform:uppercase;
    letter-spacing:1px;
  }
  .profile-line{margin-top:12px;font-size:15px;line-height:1.5;color:#e2e8f0}
  .section-label{margin-top:16px;text-transform:uppercase;font-size:12px;letter-spacing:1.4px;color:rgba(203,213,225,0.8)}
  .loader{
    position:fixed;
    inset:0;
    background:rgba(8, 15, 30, 0.72);
    backdrop-filter:blur(10px);
    display:none;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    gap:12px;
    z-index:1000;
    text-align:center;
    color:#e2e8f0;
    padding:24px;
  }
  .spinner{
    width:46px;
    height:46px;
    border-radius:50%;
    border:4px solid rgba(148,163,184,0.3);
    border-top-color:var(--acc);
    animation:spin 0.9s linear infinite;
  }
  @keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
  body.is-loading .btn{pointer-events:none;opacity:0.6}
  .match-details{margin-top:12px;display:flex;flex-direction:column;gap:8px;font-size:14px;color:#d1e3ff}
  .match-details b{font-weight:600;color:#f8fafc}
  .match-line{display:flex;flex-direction:column;gap:4px;background:rgba(148,163,184,0.08);padding:10px 12px;border-radius:12px}
  .match-line span{color:#9ca3af;text-transform:uppercase;letter-spacing:1px;font-size:11px;display:block;margin-bottom:2px}
  .match-line div{color:#f8fafc;line-height:1.45}
  .match-actions{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px}
  @media (max-width:900px){
    body{padding:24px}
    .card{padding:24px;border-radius:22px}
  }
  @media (max-width:640px){
    body{padding:18px;align-items:flex-start}
    .app{gap:16px}
    .actions{flex-direction:column}
    .actions .btn{width:100%}
    .deck{flex-direction:column}
    .profile{min-height:unset}
    .swipe-head{flex-direction:column;align-items:flex-start;gap:8px}
  }
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>Yoobee Connect ¬∑ Swipe</h1>
    <p class="sub">Find peers with similar backgrounds and interests across campuses. Mutual üëç unlocks names and contact details so you can connect directly.</p>

    <div id="screen-profile">
      <div class="row">
        <div>
          <label>Name</label>
          <input id="name" placeholder="e.g., Aroha T." />
        </div>
        <div>
          <label>Campus</label>
          <select id="campus">
            <option value="">Select campus</option>
            <option>Auckland1</option>
            <option>Auckland2</option>
            <option>Auckland3</option>
            <option>Christchurch</option>
          </select>
        </div>
        <div>
          <label>Country</label>
          <select id="country">
            <option value="">Select country</option>
            <option>Afghanistan</option>
            <option>Albania</option>
            <option>Algeria</option>
            <option>Andorra</option>
            <option>Angola</option>
            <option>Antigua and Barbuda</option>
            <option>Argentina</option>
            <option>Armenia</option>
            <option>Australia</option>
            <option>Austria</option>
            <option>Azerbaijan</option>
            <option>Bahamas</option>
            <option>Bahrain</option>
            <option>Bangladesh</option>
            <option>Barbados</option>
            <option>Belarus</option>
            <option>Belgium</option>
            <option>Belize</option>
            <option>Benin</option>
            <option>Bhutan</option>
            <option>Bolivia</option>
            <option>Bosnia and Herzegovina</option>
            <option>Botswana</option>
            <option>Brazil</option>
            <option>Brunei</option>
            <option>Bulgaria</option>
            <option>Burkina Faso</option>
            <option>Burundi</option>
            <option>Cabo Verde</option>
            <option>Cambodia</option>
            <option>Cameroon</option>
            <option>Canada</option>
            <option>Central African Republic</option>
            <option>Chad</option>
            <option>Chile</option>
            <option>China</option>
            <option>Colombia</option>
            <option>Comoros</option>
            <option>Congo, Democratic Republic of the</option>
            <option>Congo, Republic of the</option>
            <option>Costa Rica</option>
            <option>Croatia</option>
            <option>Cuba</option>
            <option>Cyprus</option>
            <option>Czechia</option>
            <option>Denmark</option>
            <option>Djibouti</option>
            <option>Dominica</option>
            <option>Dominican Republic</option>
            <option>Ecuador</option>
            <option>Egypt</option>
            <option>El Salvador</option>
            <option>Equatorial Guinea</option>
            <option>Eritrea</option>
            <option>Estonia</option>
            <option>Eswatini</option>
            <option>Ethiopia</option>
            <option>Fiji</option>
            <option>Finland</option>
            <option>France</option>
            <option>Gabon</option>
            <option>Gambia</option>
            <option>Georgia</option>
            <option>Germany</option>
            <option>Ghana</option>
            <option>Greece</option>
            <option>Grenada</option>
            <option>Guatemala</option>
            <option>Guinea</option>
            <option>Guinea-Bissau</option>
            <option>Guyana</option>
            <option>Haiti</option>
            <option>Honduras</option>
            <option>Hungary</option>
            <option>Iceland</option>
            <option>India</option>
            <option>Indonesia</option>
            <option>Iran</option>
            <option>Iraq</option>
            <option>Ireland</option>
            <option>Israel</option>
            <option>Italy</option>
            <option>Jamaica</option>
            <option>Japan</option>
            <option>Jordan</option>
            <option>Kazakhstan</option>
            <option>Kenya</option>
            <option>Kiribati</option>
            <option>Korea, North</option>
            <option>Korea, South</option>
            <option>Kosovo</option>
            <option>Kuwait</option>
            <option>Kyrgyzstan</option>
            <option>Laos</option>
            <option>Latvia</option>
            <option>Lebanon</option>
            <option>Lesotho</option>
            <option>Liberia</option>
            <option>Libya</option>
            <option>Liechtenstein</option>
            <option>Lithuania</option>
            <option>Luxembourg</option>
            <option>Madagascar</option>
            <option>Malawi</option>
            <option>Malaysia</option>
            <option>Maldives</option>
            <option>Mali</option>
            <option>Malta</option>
            <option>Marshall Islands</option>
            <option>Mauritania</option>
            <option>Mauritius</option>
            <option>Mexico</option>
            <option>Micronesia</option>
            <option>Moldova</option>
            <option>Monaco</option>
            <option>Mongolia</option>
            <option>Montenegro</option>
            <option>Morocco</option>
            <option>Mozambique</option>
            <option>Myanmar</option>
            <option>Namibia</option>
            <option>Nauru</option>
            <option>Nepal</option>
            <option>Netherlands</option>
            <option>New Zealand</option>
            <option>Nicaragua</option>
            <option>Niger</option>
            <option>Nigeria</option>
            <option>North Macedonia</option>
            <option>Norway</option>
            <option>Oman</option>
            <option>Pakistan</option>
            <option>Palau</option>
            <option>Panama</option>
            <option>Papua New Guinea</option>
            <option>Paraguay</option>
            <option>Peru</option>
            <option>Philippines</option>
            <option>Poland</option>
            <option>Portugal</option>
            <option>Qatar</option>
            <option>Romania</option>
            <option>Russia</option>
            <option>Rwanda</option>
            <option>Saint Kitts and Nevis</option>
            <option>Saint Lucia</option>
            <option>Saint Vincent and the Grenadines</option>
            <option>Samoa</option>
            <option>San Marino</option>
            <option>Sao Tome and Principe</option>
            <option>Saudi Arabia</option>
            <option>Senegal</option>
            <option>Serbia</option>
            <option>Seychelles</option>
            <option>Sierra Leone</option>
            <option>Singapore</option>
            <option>Slovakia</option>
            <option>Slovenia</option>
            <option>Solomon Islands</option>
            <option>Somalia</option>
            <option>South Africa</option>
            <option>South Sudan</option>
            <option>Spain</option>
            <option>Sri Lanka</option>
            <option>Sudan</option>
            <option>Suriname</option>
            <option>Sweden</option>
            <option>Switzerland</option>
            <option>Syria</option>
            <option>Taiwan</option>
            <option>Tajikistan</option>
            <option>Tanzania</option>
            <option>Thailand</option>
            <option>Timor-Leste</option>
            <option>Togo</option>
            <option>Tonga</option>
            <option>Trinidad and Tobago</option>
            <option>Tunisia</option>
            <option>Turkey</option>
            <option>Turkmenistan</option>
            <option>Tuvalu</option>
            <option>Uganda</option>
            <option>Ukraine</option>
            <option>United Arab Emirates</option>
            <option>United Kingdom</option>
            <option>United States</option>
            <option>Uruguay</option>
            <option>Uzbekistan</option>
            <option>Vanuatu</option>
            <option>Vatican City</option>
            <option>Venezuela</option>
            <option>Vietnam</option>
            <option>Yemen</option>
            <option>Zambia</option>
            <option>Zimbabwe</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Background (e.g., Nursing, IT, Design)</label>
          <input id="background" />
        </div>
        <div>
          <label>Teams Email (revealed only on match)</label>
          <input id="teams" placeholder="your.name@yoobee.ac.nz" />
        </div>
      </div>

      <label>Interests (comma-separated)</label>
      <input id="interests" placeholder="health-tech, UX, data viz" />

      <div class="actions">
        <button class="btn primary" id="btn-start">Save & Start Swiping</button>
        <button class="btn ghost" id="btn-restore">I have a Join Code</button>
      </div>
      <p class="hint">We store a one-time <b>Join Code</b> in your browser. If you switch devices, use ‚ÄúI have a Join Code‚Äù.</p>
      <div id="restore-form" style="display:none;margin-top:8px">
        <label>Join Code</label>
        <input id="restore-code" placeholder="e.g., Q7M3KX" />
        <div class="actions">
          <button class="btn" id="btn-restore-do">Restore Session</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="muted">Privacy: until you match, others only see your country, background, and interests. Names, campuses, and email unlock after a mutual üëç.</div>
    </div>

    <div id="screen-swipe" style="display:none">
      <div class="swipe-head">
        <h3>Swipe candidates</h3>
      </div>
      <div id="match-alert" class="match" style="display:none"></div>
      <div class="deck">
        <div class="profile" id="card" style="display:none">
          <div class="muted" id="p-status">Name is hidden until you both match.</div>
          <div id="p-country" class="tag-list" style="margin-top:12px"></div>
          <div id="p-bg" class="profile-line"></div>
          <div id="p-interests-wrap" style="display:none">
            <div class="section-label">Interests</div>
            <div class="badges" id="p-interests"></div>
          </div>
          <div class="hr"></div>
          <div class="hint">Think about what you could collaborate on or ask about their journey when you match.</div>
        </div>
        <div class="profile center" id="empty" style="display:none">
          <div>
            <h3>No more candidates right now</h3>
            <p class="muted">Hang tight; others are still joining. You can revisit in a few seconds.</p>
            <div class="actions center" style="justify-content:center">
              <button class="btn" id="btn-refresh">Refresh</button>
            </div>
          </div>
        </div>
      </div>
      <div class="actions" id="swipe-actions" style="display:none">
        <button class="btn ghost" id="btn-no">üëé Pass</button>
        <button class="btn primary" id="btn-yes">üëç Connect</button>
      </div>
    </div>

  </div>
</div>

<div class="loader" id="loader" role="status" aria-live="assertive" aria-hidden="true">
  <div class="spinner" aria-hidden="true"></div>
  <p id="loader-text">Loading...</p>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxflqP3IsvUZVC5AZbIr470JkBEXfcYTrxHkBRlpIq7AI3kUR2yQPB8tWm2W9ms03ME/exec";
let joinCode = localStorage.getItem("joinCode") || null;
let myProfile = null;
let deck = [];
let current = null;
let loadingCount = 0;

function toggleLoader(show, message = 'Working...') {
  const loader = document.getElementById('loader');
  if(!loader) return;
  const text = document.getElementById('loader-text');
  if(show){
    loadingCount++;
    if(message && text) text.textContent = message;
    loader.style.display = 'flex';
    loader.setAttribute('aria-hidden','false');
    document.body.classList.add('is-loading');
  } else {
    loadingCount = Math.max(0, loadingCount-1);
    if(loadingCount===0){
      loader.style.display = 'none';
      loader.setAttribute('aria-hidden','true');
      document.body.classList.remove('is-loading');
    }
  }
}

function escapeHtml(value){
  return String(value ?? '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

function asList(value){
  if(Array.isArray(value)) return value.filter(Boolean);
  if(typeof value === 'string'){
    return value.split(',').map(v=>v.trim()).filter(Boolean);
  }
  return [];
}

function show(id, display='block'){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = display;
  el.setAttribute('aria-hidden','false');
}

function hide(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = 'none';
  el.setAttribute('aria-hidden','true');
}

function pills(parent, values){
  if(!parent) return;
  parent.innerHTML='';
  asList(values).forEach(v=>{
    const span=document.createElement('span');
    span.className='pill';
    span.textContent=v;
    parent.appendChild(span);
  });
}

async function apiPost(body, message='Working...'){
  toggleLoader(true, message);
  try{
    const r = await fetch(API, { method:'POST', body:JSON.stringify(body)});
    if(!r.ok) throw new Error('Network response was not ok');
    return await r.json();
  } finally {
    toggleLoader(false);
  }
}

async function apiGet(params, message='Loading...'){
  toggleLoader(true, message);
  try{
    const url = API + "?" + new URLSearchParams(params).toString();
    const r = await fetch(url);
    if(!r.ok) throw new Error('Network response was not ok');
    return await r.json();
  } finally {
    toggleLoader(false);
  }
}

function renderCard(p){
  const cardEl = document.getElementById('card');
  const emptyEl = document.getElementById('empty');
  const actionsEl = document.getElementById('swipe-actions');

  if(!p){
    if(cardEl){
      cardEl.style.display='none';
      cardEl.setAttribute('aria-hidden','true');
    }
    if(emptyEl){
      emptyEl.style.display='flex';
      emptyEl.setAttribute('aria-hidden','false');
    }
    if(actionsEl){
      actionsEl.style.display='none';
    }
    return;
  }

  if(cardEl){
    cardEl.style.display='flex';
    cardEl.setAttribute('aria-hidden','false');
  }
  if(emptyEl){
    emptyEl.style.display='none';
    emptyEl.setAttribute('aria-hidden','true');
  }
  if(actionsEl){
    actionsEl.style.display='flex';
  }

  const statusEl = document.getElementById('p-status');
  if(statusEl){
    statusEl.textContent = 'Name is hidden until you both match.';
  }

  const countryEl = document.getElementById('p-country');
  if(countryEl){
    countryEl.innerHTML='';
    if(p.country){
      const tag=document.createElement('span');
      tag.className='tag';
      tag.textContent=p.country;
      countryEl.appendChild(tag);
      countryEl.style.display='flex';
    } else {
      countryEl.style.display='none';
    }
  }

  const bgEl = document.getElementById('p-bg');
  if(bgEl){
    bgEl.textContent = p.background ? `Background: ${p.background}` : '';
  }

  const interestsWrap = document.getElementById('p-interests-wrap');
  const interestsEl = document.getElementById('p-interests');
  const interests = asList(p.interests);
  if(interestsWrap && interestsEl){
    if(interests.length){
      interestsWrap.style.display='block';
      pills(interestsEl, interests);
    } else {
      interestsWrap.style.display='none';
      interestsEl.innerHTML='';
    }
  }
}

async function nextCard(){
  if(deck.length===0){
    try{
      const res = await apiGet({ action:'candidates', code:joinCode }, 'Finding peers...');
      deck = (res && res.candidates) || [];
    } catch(err){
      console.error(err);
      alert('Unable to load new candidates right now. Please try again in a moment.');
      renderCard(null);
      return;
    }
  }

  current = deck.shift() || null;
  renderCard(current);
}

async function onSwipe(dir){
  if(!current) return;
  let res;
  try{
    res = await apiPost({ action:'swipe', code:joinCode, target:current.code, dir }, dir==='right' ? 'Sending like...' : 'Recording pass...');
  } catch(err){
    console.error(err);
    alert('Unable to send your swipe. Please try again.');
    return;
  }

  if(res && res.matched){
    const partner = res.partner || {};
    const box = document.getElementById('match-alert');
    const lines = [];
    const addLine = (label, value)=>{
      if(!value) return;
      lines.push(`<div class="match-line"><span>${escapeHtml(label)}</span><div>${escapeHtml(value)}</div></div>`);
    };

    const partnerName = partner.name || 'New connection';
    const emailRaw = (partner.teams || '').trim();
    const interestsList = asList(partner.interests);

    addLine('Name', partnerName);
    addLine('Campus', partner.campus);
    addLine('Country', partner.country);
    addLine('Background', partner.background);
    if(interestsList.length){
      addLine('Interests', interestsList.join(', '));
    }
    if(emailRaw){
      addLine('Email', emailRaw);
    }

    if(box){
      const actions = [];
      if(emailRaw){
        const safeEmail = escapeHtml(emailRaw);
        const firstName = escapeHtml(partnerName.split(' ')[0] || 'match');
        actions.push(`<a class="btn primary" href="mailto:${safeEmail}" target="_blank">Email ${firstName}</a>`);
        actions.push(`<a class="btn" href="https://teams.microsoft.com/l/chat/0/0?users=${encodeURIComponent(emailRaw)}" target="_blank">Open in Teams</a>`);
      }
      box.style.display='block';
      box.innerHTML = `
        <b>üéâ It's a match!</b>
        <div class="match-details">
          ${lines.join('')}
        </div>
        ${actions.length ? `<div class="match-actions">${actions.join('')}</div>` : '<div class="hint">Ask your facilitator to help exchange contact details.</div>'}
      `;
    }
  }

  await nextCard();
}

async function saveProfile(){
  const name = document.getElementById('name').value.trim();
  const campus = document.getElementById('campus').value.trim();
  const country = document.getElementById('country').value.trim();
  const background = document.getElementById('background').value.trim();
  const teams = document.getElementById('teams').value.trim();
  const interests = document.getElementById('interests').value.split(',').map(s=>s.trim()).filter(Boolean);

  if(!name || !campus || !country || !background){
    alert('Please complete Name, Campus, Country, and Background.');
    return;
  }

  let res;
  try{
    res = await apiPost({ action:'register', name, campus, country, background, interests, teams }, 'Saving your profile...');
  } catch(err){
    console.error(err);
    alert('Unable to save your profile. Please try again.');
    return;
  }

  if(!res || !res.ok){
    alert((res && res.error) || 'Something went wrong.');
    return;
  }

  joinCode = res.code;
  localStorage.setItem('joinCode', joinCode);
  myProfile = res.profile;
  deck = [];
  current = null;

  hide('screen-profile');
  show('screen-swipe');
  hide('restore-form');
  const matchAlert = document.getElementById('match-alert');
  if(matchAlert){
    matchAlert.style.display='none';
  }
  await nextCard();
}

async function restore(){
  const code = document.getElementById('restore-code').value.trim();
  if(!code){
    alert('Enter your Join Code');
    return;
  }

  let res;
  try{
    res = await apiGet({ action:'restore', code }, 'Restoring session...');
  } catch(err){
    console.error(err);
    alert('Unable to restore your session right now. Please try again.');
    return;
  }

  if(!res || !res.ok){
    alert((res && res.error) || 'Invalid code');
    return;
  }

  joinCode = code;
  localStorage.setItem('joinCode', joinCode);
  myProfile = res.profile;
  deck = [];
  current = null;

  hide('screen-profile');
  show('screen-swipe');
  hide('restore-form');
  const matchAlert = document.getElementById('match-alert');
  if(matchAlert){
    matchAlert.style.display='none';
  }
  await nextCard();
}

document.getElementById('btn-start').onclick = saveProfile;
document.getElementById('btn-no').onclick = ()=>onSwipe('left');
document.getElementById('btn-yes').onclick = ()=>onSwipe('right');
document.getElementById('btn-refresh').onclick = ()=>{
  deck = [];
  nextCard();
};

document.getElementById('btn-restore').onclick = ()=>show('restore-form');
document.getElementById('btn-restore-do').onclick = restore;

(async function boot(){
  if(joinCode){
    try{
      const res = await apiGet({ action:'restore', code:joinCode }, 'Restoring session...');
      if(res && res.ok){
        myProfile = res.profile;
        deck = [];
        current = null;
        hide('screen-profile');
        show('screen-swipe');
        hide('restore-form');
        const matchAlert = document.getElementById('match-alert');
        if(matchAlert){
          matchAlert.style.display='none';
        }
        await nextCard();
        return;
      }
      localStorage.removeItem('joinCode');
    } catch(err){
      console.error(err);
      localStorage.removeItem('joinCode');
    }
  }
})();
</script>
</body>
</html>


