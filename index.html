<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Yoobee Connect ¬∑ Swipe</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,#0b1022,#0f172a 60%);color:var(--text);display:flex;min-height:100vh;align-items:center;justify-content:center;padding:24px}
  .app{width:100%;max-width:720px}
  .card{background:rgba(17,24,39,.7);backdrop-filter: blur(6px);border:1px solid #1f2937;border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 6px;font-weight:750;letter-spacing:.2px}
  .sub{color:var(--muted);margin:0 0 16px}
  label{display:block;margin:10px 0 6px;color:#cbd5e1}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #293548;background:#0b1220;color:var(--text)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;background:#1f2a44;color:#e5e7eb;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#06b6d4,#22d3ee)}
  .btn.ghost{background:transparent;border:1px solid #304063}
  .actions{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap}
  .deck{display:flex;gap:16px;align-items:stretch;margin-top:10px}
  .profile{flex:1;border:1px solid #24304f;border-radius:16px;padding:16px;background:#0b1220}
  .pill{display:inline-flex;gap:6px;background:#12203d;border:1px solid #213357;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;color:#cde8ff;font-size:13px}
  .badges{margin-top:8px}
  .foot{margin-top:14px;color:#93a3c7;font-size:14px}
  .hr{height:1px;background:#1f2937;margin:14px 0}
  .muted{color:#9ca3af}
  .center{display:flex;align-items:center;justify-content:center}
  .match{border:1px solid #2b3e6a;background:#101a33;padding:14px;border-radius:12px;margin-top:12px}
  .timer{font-variant-numeric:tabular-nums;color:#86efac;font-weight:700}
  .hint{font-size:13px;color:#a3b2d6}
  .right{float:right}
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>Yoobee Connect ¬∑ Swipe</h1>
    <p class="sub">Find peers with similar backgrounds/interests across campuses. Mutual üëç = match ‚Üí chat on Teams for 10 minutes.</p>

    <div id="screen-profile">
      <div class="row">
        <div>
          <label>Name</label>
          <input id="name" placeholder="e.g., Aroha T." />
        </div>
        <div>
          <label>Campus</label>
          <select id="campus">
            <option value="">Select campus</option>
            <option>Christchurch</option>
            <option>Auckland</option>
            <option>Wellington</option>
            <option>Dunedin</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Background (e.g., Nursing, IT, Design)</label>
          <input id="background" />
        </div>
        <div>
          <label>Teams Email (revealed only on match)</label>
          <input id="teams" placeholder="your.name@yoobee.ac.nz" />
        </div>
      </div>

      <label>Interests (comma-separated)</label>
      <input id="interests" placeholder="health-tech, UX, data viz" />

      <div class="actions">
        <button class="btn primary" id="btn-start">Save & Start Swiping</button>
        <button class="btn ghost" id="btn-restore">I have a Join Code</button>
      </div>
      <p class="hint">We store a one-time <b>Join Code</b> in your browser. If you switch devices, use ‚ÄúI have a Join Code‚Äù.</p>
      <div id="restore-form" style="display:none;margin-top:8px">
        <label>Join Code</label>
        <input id="restore-code" placeholder="e.g., Q7M3KX" />
        <div class="actions">
          <button class="btn" id="btn-restore-do">Restore Session</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="muted">Privacy: nothing is public until a mutual üëç match. Only name, campus, background & interests are shown pre-match.</div>
    </div>

    <div id="screen-swipe" style="display:none">
      <div class="right hint">Time left: <span class="timer" id="timer">10:00</span></div>
      <h3>Swipe candidates</h3>
      <div id="match-alert" class="match" style="display:none"></div>
      <div class="deck">
        <div class="profile" id="card" style="display:none">
          <div class="muted">Candidate</div>
          <h2 id="p-name" style="margin:6px 0 0"></h2>
          <div id="p-campus" class="muted"></div>
          <div id="p-bg" style="margin-top:6px"></div>
          <div class="badges" id="p-interests"></div>
          <div class="hr"></div>
          <div class="hint">Icebreakers: What brought you to this field? Favourite local study spot? One fun fact?</div>
        </div>
        <div class="profile center" id="empty" style="display:none">
          <div>
            <h3>No more candidates right now</h3>
            <p class="muted">Hang tight; others are still joining. You can revisit in a few seconds.</p>
            <div class="actions center" style="justify-content:center">
              <button class="btn" id="btn-refresh">Refresh</button>
            </div>
          </div>
        </div>
      </div>
      <div class="actions" id="swipe-actions" style="display:none">
        <button class="btn ghost" id="btn-no">üëé Pass</button>
        <button class="btn primary" id="btn-yes">üëç Connect</button>
      </div>
    </div>

  </div>
</div>

<script>
const API = "YOUR_APPS_SCRIPT_WEB_APP_URL"; // <-- replace after you deploy Apps Script
let joinCode = localStorage.getItem("joinCode") || null;
let myProfile = null;
let deck = [];
let current = null;
let timerId = null, remaining = 10*60; // 10 minutes

function fmtTimer(s){
  const m = Math.floor(s/60), r = s%60;
  return `${m}:${r.toString().padStart(2,'0')}`;
}
function startTimer(){
  clearInterval(timerId);
  document.getElementById('timer').textContent = fmtTimer(remaining);
  timerId = setInterval(()=>{
    remaining = Math.max(0, remaining-1);
    document.getElementById('timer').textContent = fmtTimer(remaining);
    if(remaining===0) clearInterval(timerId);
  },1000);
}

function show(id){ document.getElementById(id).style.display='block'; }
function hide(id){ document.getElementById(id).style.display='none'; }
function pills(parent, arr){
  parent.innerHTML='';
  (arr||[]).forEach(v=>{
    const span=document.createElement('span');
    span.className='pill'; span.textContent=v;
    parent.appendChild(span);
  });
}

async function apiPost(body){
  const r = await fetch(API, { method:'POST',body:JSON.stringify(body)});
  return await r.json();
}
async function apiGet(params){
  const url = API + "?" + new URLSearchParams(params).toString();
  const r = await fetch(url); return await r.json();
}

function renderCard(p){
  if(!p){ hide('card'); show('empty'); hide('swipe-actions'); return; }
  show('card'); hide('empty'); show('swipe-actions');
  document.getElementById('p-name').textContent = p.name || 'Student';
  document.getElementById('p-campus').textContent = p.campus || '';
  document.getElementById('p-bg').textContent = p.background ? "Background: " + p.background : '';
  pills(document.getElementById('p-interests'), p.interests || []);
}

async function nextCard(){
  if(deck.length===0){
    const res = await apiGet({ action:'candidates', code:joinCode });
    deck = res.candidates || [];
  }
  current = deck.shift() || null;
  renderCard(current);
}

async function onSwipe(dir){
  if(!current) return;
  const res = await apiPost({ action:'swipe', code:joinCode, target:current.code, dir });
  if(res.matched){
    const box = document.getElementById('match-alert');
    const partner = res.partner;
    box.style.display='block';
    const teamsLink = partner.teams ? `https://teams.microsoft.com/l/chat/0/0?users=${encodeURIComponent(partner.teams)}` : null;
    box.innerHTML = `
      <b>üéâ It's a match with ${partner.name}!</b><br/>
      Campus: ${partner.campus || ''} ¬∑ Background: ${partner.background || ''}<br/>
      ${teamsLink ? `<a href="${teamsLink}" target="_blank" class="btn" style="display:inline-block;margin-top:8px">Open Teams chat</a>` : '<span class="hint">Ask your facilitator to share contact</span>'}
    `;
  }
  await nextCard();
}

async function saveProfile(){
  const name = document.getElementById('name').value.trim();
  const campus = document.getElementById('campus').value.trim();
  const background = document.getElementById('background').value.trim();
  const teams = document.getElementById('teams').value.trim();
  const interests = document.getElementById('interests').value.split(',').map(s=>s.trim()).filter(Boolean);

  if(!name || !campus || !background){ alert("Please complete Name, Campus, and Background."); return; }

  const res = await apiPost({ action:'register', name, campus, background, interests, teams });
  if(!res.ok){ alert(res.error || "Error"); return; }
  joinCode = res.code;
  localStorage.setItem('joinCode', joinCode);
  myProfile = res.profile;

  hide('screen-profile'); show('screen-swipe');
  startTimer();
  await nextCard();
}

async function restore(){
  const code = document.getElementById('restore-code').value.trim();
  if(!code){ alert('Enter your Join Code'); return; }
  const res = await apiGet({ action:'restore', code });
  if(!res.ok){ alert(res.error || 'Invalid code'); return; }
  joinCode = code; localStorage.setItem('joinCode', joinCode);
  myProfile = res.profile;
  hide('screen-profile'); show('screen-swipe');
  startTimer();
  await nextCard();
}

document.getElementById('btn-start').onclick = saveProfile;
document.getElementById('btn-no').onclick = ()=>onSwipe('left');
document.getElementById('btn-yes').onclick = ()=>onSwipe('right');
document.getElementById('btn-refresh').onclick = nextCard;

document.getElementById('btn-restore').onclick = ()=>show('restore-form');
document.getElementById('btn-restore-do').onclick = restore;

// Auto-restore if joinCode exists
(async function boot(){
  if(joinCode){
    const res = await apiGet({ action:'restore', code:joinCode });
    if(res.ok){
      myProfile = res.profile;
      hide('screen-profile'); show('screen-swipe');
      startTimer();
      await nextCard();
    }
  }
})();
</script>
</body>
</html>
