<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yoobee Connect</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--sub:#94a3b8;--text:#f8fafc;--acc:#22d3ee}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1222,#0f172a 40%,#0b1222);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:900px;margin:40px auto;padding:20px}
    h1,h2{margin:0 0 10px}
    h1{font-size:28px}
    h2{font-size:20px;color:var(--sub)}
    .card{background:rgba(17,24,39,.8);border:1px solid rgba(255,255,255,.07);border-radius:18px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    label{display:block;font-size:13px;color:var(--sub);margin-bottom:6px}
    input,textarea,select{width:100%;background:#0b1326;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:12px 14px;border-radius:12px;outline:none}
    textarea{min-height:84px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid rgba(255,255,255,.12);background:#0b1326;color:var(--text);padding:11px 14px;border-radius:12px}
    .btn.acc{background:var(--acc);color:#001317;border-color:transparent}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .center{display:flex;align-items:center;justify-content:center}
    .stack{display:flex;flex-direction:column;gap:12px}
    .pill{display:inline-flex;gap:8px;flex-wrap:wrap}
    .tag{font-size:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px}
    .muted{color:var(--sub)}
    .spacer{height:8px}
    hr{border:none;height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    #status{font-size:13px;color:var(--sub)}
    /* Swipe card */
    .swipe-card{border:1px dashed rgba(255,255,255,.15);border-radius:16px;padding:16px}
    .who{font-size:18px}
    .actions{display:flex;gap:12px;justify-content:space-between}
    .col{display:flex;flex-direction:column;gap:14px}
    .matches .item{padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:12px;margin-bottom:10px;background:rgba(255,255,255,.03)}
    .small{font-size:12px}
    .right{float:right}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap grid">
    <!-- LEFT: Profile / Swipe -->
    <div class="stack">
      <div class="card" id="screen-profile">
        <h1>Yoobee Connect</h1>
        <h2>Create your profile (one-time)</h2>
        <div class="spacer"></div>
        <div class="row">
          <div>
            <label>Name</label>
            <input id="name" placeholder="e.g., Kauri H. (A7)" />
          </div>
          <div>
            <label>Campus</label>
            <select id="campus">
              <option value="">Select campus‚Ä¶</option>
              <option>Auckland1</option>
              <option>Auckland2</option>
              <option>Auckland3</option>
              <option>Christchurch</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Country</label>
            <input id="country" placeholder="e.g., New Zealand" />
          </div>
          <div>
            <label>Background</label>
            <input id="background" placeholder="e.g., Computer Science" />
          </div>
        </div>
        <div>
          <label>Interests (comma separated)</label>
          <textarea id="interests" placeholder="e.g., AI, Robotics, Cloud"></textarea>
        </div>
        <div>
          <label>Teams / Contact (optional)</label>
          <input id="teams" placeholder="yourname@yoobee.ac.nz" />
        </div>
        <div class="row">
          <button class="btn acc" id="btn-register">Save & Start</button>
          <button class="btn ghost" id="btn-restore">I already have a code</button>
        </div>
        <div id="status" class="spacer"></div>
      </div>

      <div class="card hidden" id="screen-swipe">
        <div>
          <b>Welcome, <span id="me-name">‚Äî</span></b>
          <span class="small muted right">Code: <span id="me-code">‚Äî</span></span>
        </div>
        <hr/>
        <div class="swipe-card" id="candidate-card">
          <div id="candidate-empty" class="center">
            <div class="muted">No more candidates right now. We‚Äôll keep checking for new matches‚Ä¶</div>
          </div>
          <div id="candidate" class="hidden">
            <div class="who"><span id="c-name">‚Äî</span></div>
            <div class="small muted" id="c-meta">‚Äî</div>
            <div class="pill" id="c-tags"></div>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="btn-left">üëé Pass</button>
          <button class="btn acc" id="btn-right">üëç Connect</button>
          <button class="btn ghost" id="btn-refresh">‚Üª Refresh matches</button>
        </div>
        <div class="row">
          <button class="btn ghost" id="btn-logout">Sign out</button>
          <div id="status2" class="small muted center"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Matches -->
    <div class="card col">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Your Matches</h2>
        <div class="small muted" id="last-sync">Last sync: ‚Äî</div>
      </div>
      <div id="matches" class="matches"></div>
    </div>
  </div>

<script>
/* ==========================
   CONFIG
========================== */
const BASE_URL = 'https://script.google.com/macros/s/AKfycbxflqP3IsvUZVC5AZbIr470JkBEXfcYTrxHkBRlpIq7AI3kUR2yQPB8tWm2W9ms03ME/exec';
/* ==========================
   STATE
========================== */
let joinCode = null;
let meProfile = null;
let deck = [];           // candidate queue
let swiped = new Set();  // in-session memory
let matchList = [];      // [{ts, partner:{...}}]
let current = null;

// polling
let matchPollTimer = null;
const MATCH_POLL_MS = 15000;

/* ==========================
   DOM helpers
========================== */
const el = id => document.getElementById(id);
const show = id => el(id).classList.remove('hidden');
const hide = id => el(id).classList.add('hidden');
function setStatus(msg, where='status'){ el(where).textContent = msg || ''; }

/* ==========================
   STORAGE
========================== */
function saveSession(){
  localStorage.setItem('yc_code', joinCode || '');
  localStorage.setItem('yc_profile', JSON.stringify(meProfile||{}));
}
function loadSession(){
  joinCode = localStorage.getItem('yc_code') || '';
  try{ meProfile = JSON.parse(localStorage.getItem('yc_profile')||'{}'); }catch{ meProfile = {}; }
}
function clearSession(){
  localStorage.removeItem('yc_code');
  localStorage.removeItem('yc_profile');
}

/* ==========================
   API
========================== */
async function apiGet(params){
  const url = new URL(BASE_URL);
  Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, v));
  const r = await fetch(url.toString(), { method:'GET', headers: { 'Cache-Control':'no-cache' }});
  return r.json();
}
async function apiPost(body){
  const r = await fetch(BASE_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  return r.json();
}

/* ==========================
   MATCH POLLING
========================== */
function startMatchPolling(){
  stopMatchPolling();
  if(!joinCode) return;
  const tick = async () => {
    if(document.visibilityState === 'visible' && joinCode){
      try { await syncMatchesFromServer(); } catch(_e){}
    }
  };
  matchPollTimer = setInterval(tick, MATCH_POLL_MS);
  setTimeout(tick, 1000);
}
function stopMatchPolling(){
  if(matchPollTimer){ clearInterval(matchPollTimer); matchPollTimer = null; }
}
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'visible' && joinCode){
    syncMatchesFromServer().catch(()=>{});
  }
});

/* ==========================
   FLOWS
========================== */
async function saveProfile(){
  const name = el('name').value.trim();
  const campus = el('campus').value.trim();
  const country = el('country').value.trim();
  const background = el('background').value.trim();
  const interests = el('interests').value.trim();
  const teams = el('teams').value.trim();
  setStatus('Saving‚Ä¶');
  const res = await apiPost({ action:'register', name, campus, country, background, interests, teams });
  if(!res.ok){ setStatus('Error: ' + res.error); return; }
  joinCode = res.code;
  meProfile = res.profile||{};
  saveSession();
  el('me-name').textContent = meProfile.name || name;
  el('me-code').textContent = joinCode;
  setStatus('');
  hide('screen-profile'); show('screen-swipe');
  startMatchPolling();
  await fetchCandidates();
  await syncMatchesFromServer(); // initial hydrate
  await nextCard();
}

async function restore(){
  loadSession();
  const code = prompt('Enter your join code:', joinCode || '');
  if(!code){ return; }
  setStatus('Restoring‚Ä¶');
  const res = await apiGet({ action:'restore', code });
  if(!res.ok){ setStatus('Error: ' + res.error); return; }
  joinCode = code.toUpperCase();
  meProfile = res.profile||{};
  matchList = Array.isArray(res.matches)? res.matches : [];
  saveSession();
  el('me-name').textContent = meProfile.name || '‚Äî';
  el('me-code').textContent = joinCode;
  setStatus('');
  hide('screen-profile'); show('screen-swipe');
  startMatchPolling();
  renderMatches();
  await fetchCandidates();
  await nextCard();
}

function logout(){
  stopMatchPolling();
  clearSession();
  joinCode = null;
  meProfile = null;
  deck = []; swiped.clear(); matchList = []; current=null;
  el('matches').innerHTML = '';
  hide('screen-swipe'); show('screen-profile');
  setStatus('', 'status2');
}

/* ==========================
   CANDIDATES & SWIPES
========================== */
async function fetchCandidates(){
  if(!joinCode) return;
  setStatus('Loading candidates‚Ä¶','status2');
  const res = await apiGet({ action:'candidates', code: joinCode });
  if(!res.ok){ setStatus('Error: ' + res.error, 'status2'); return; }
  // server already filters swiped/matched; still dedupe on client
  const seen = new Set(deck.map(d=>d.code));
  res.candidates.forEach(c=>{ if(!seen.has(c.code) && c.code!==joinCode) deck.push(c); });
  setStatus('', 'status2');
}

async function onSwipe(dir){
  if(!current) return;
  const target = current.code;
  swiped.add(target);
  const res = await apiPost({ action:'swipe', code: joinCode, target, dir });
  if(res.matched && res.partner){
    recordMatch(res.partner);
  }
  await nextCard();
  // pick up any pairs created while we were idle
  try { await syncMatchesFromServer(); } catch(_e){}
}

async function nextCard(){
  // find the next candidate that isn't me and isn't already matched
  const matchedCodes = new Set(matchList.map(m=> (m.partner && m.partner.code) ? m.partner.code : null));
  let next = null;
  while(deck.length){
    const c = deck.shift();
    if(!c || c.code===joinCode) continue;
    if(swiped.has(c.code)) continue;
    if(matchedCodes.has(c.code)) continue;
    next = c; break;
  }
  current = next;
  renderCandidate();
  if(!current){
    // try to refill once
    await fetchCandidates();
    if(deck.length){ return nextCard(); }
  }
}

/* ==========================
   RENDER
========================== */
function renderCandidate(){
  const empty = el('candidate-empty');
  const block = el('candidate');
  if(!current){
    show('candidate-empty'); hide('candidate');
    el('c-name').textContent = '';
    el('c-meta').textContent = '';
    el('c-tags').innerHTML = '';
    return;
  }
  hide('candidate-empty'); show('candidate');
  el('c-name').textContent = current.name || '(No name)';
  el('c-meta').textContent = `${current.campus||'‚Äî'} ‚Ä¢ ${current.country||'‚Äî'} ‚Ä¢ ${current.background||'‚Äî'}`;
  el('c-tags').innerHTML = (current.interests||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('') || '<span class="muted small">No interests listed</span>';
}

function renderMatches(){
  const box = el('matches');
  box.innerHTML = '';
  if(!matchList.length){
    box.innerHTML = '<div class="muted small">No matches yet.</div>';
    return;
  }
  matchList.forEach(m=>{
    const p = m.partner || {};
    const when = m.ts ? new Date(m.ts).toLocaleString() : '';
    const tags = (p.interests||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('');
    const teams = p.teams ? `<div class="small">Teams: <b>${escapeHtml(p.teams)}</b></div>` : '';
    const codeSpan = p.code ? `<div class="small muted">Code: ${escapeHtml(p.code)}</div>` : '';
    box.insertAdjacentHTML('beforeend', `
      <div class="item">
        <div><b>${escapeHtml(p.name||'Unknown')}</b></div>
        <div class="small muted">${escapeHtml(p.campus||'‚Äî')} ‚Ä¢ ${escapeHtml(p.country||'‚Äî')} ‚Ä¢ ${escapeHtml(p.background||'‚Äî')}</div>
        <div class="pill" style="margin-top:6px">${tags||'<span class="small muted">No interests</span>'}</div>
        ${teams}
        ${codeSpan}
        <div class="small muted" style="margin-top:6px">Matched: ${escapeHtml(when)}</div>
      </div>
    `);
  });
}

/* ==========================
   MATCH SYNC
========================== */
function recordMatch(partner){
  // normalize + keep latest on top by ts
  const ts = Date.now();
  const norm = {
    ts,
    partner: {
      code: partner.code || partner.id || '',
      name: partner.name || '',
      campus: partner.campus || '',
      country: partner.country || '',
      background: partner.background || '',
      interests: Array.isArray(partner.interests) ? partner.interests.slice() : [],
      teams: partner.teams || ''
    }
  };
  // de-dup by code
  const code = norm.partner.code || (norm.partner.name + '|' + norm.ts);
  const seen = new Set(matchList.map(m => (m.partner && m.partner.code) ? m.partner.code : ''));
  if(!seen.has(code)){ matchList.unshift(norm); }
  renderMatches();
}

function applyServerMatches(serverMatches){
  // server returns [{ts, partner:{name,...}}] (ts may be numeric)
  // replace local with server truth (sorted desc ts)
  if(!Array.isArray(serverMatches)) return;
  matchList = serverMatches.slice().sort((a,b)=> (b.ts||0)-(a.ts||0));
  renderMatches();
}

async function syncMatchesFromServer(){
  if(!joinCode) return;
  const res = await apiGet({ action:'matches', code: joinCode });
  if(!res.ok) return;
  applyServerMatches(res.matches||[]);
  el('last-sync').textContent = 'Last sync: ' + new Date().toLocaleTimeString();
}

/* ==========================
   UTIL
========================== */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ==========================
   WIRE UP
========================== */
el('btn-register').addEventListener('click', saveProfile);
el('btn-restore').addEventListener('click', restore);
el('btn-logout').addEventListener('click', logout);
el('btn-left').addEventListener('click', ()=> onSwipe('left'));
el('btn-right').addEventListener('click', ()=> onSwipe('right'));
el('btn-refresh').addEventListener('click', ()=> syncMatchesFromServer());

window.addEventListener('load', async ()=>{
  loadSession();
  if(joinCode){
    // fast restore
    try{
      const res = await apiGet({ action:'restore', code: joinCode });
      if(res.ok){
        meProfile = res.profile||{};
        matchList = res.matches||[];
        el('me-name').textContent = meProfile.name || '‚Äî';
        el('me-code').textContent = joinCode;
        hide('screen-profile'); show('screen-swipe');
        startMatchPolling();
        renderMatches();
        await fetchCandidates();
        await nextCard();
        return;
      }
    }catch(_e){}
  }
  // fallback to profile screen
  hide('screen-swipe'); show('screen-profile');
});
</script>
</body>
</html>

