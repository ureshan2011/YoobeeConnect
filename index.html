<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yoobee Connect</title>
  <style>
    :root {
      --bg: #f5f5f7;
      --surface: #ffffff;
      --surface-soft: rgba(0, 0, 0, 0.03);
      --border: rgba(0, 0, 0, 0.08);
      --border-strong: rgba(0, 0, 0, 0.12);
      --text: #1d1d1f;
      --sub: #6e6e73;
      --accent: #0a84ff;
      --accent-soft: rgba(10, 132, 255, 0.12);
      --radius-lg: 22px;
      --shadow-lg: 0 20px 50px rgba(15, 23, 42, 0.08), 0 10px 30px rgba(15, 23, 42, 0.05);
      --shadow-soft: 0 12px 26px rgba(15, 23, 42, 0.06);
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top right, rgba(10, 132, 255, 0.08), transparent 55%),
                  radial-gradient(circle at bottom left, rgba(52, 199, 89, 0.06), transparent 60%),
                  var(--bg);
      color: var(--text);
      font: 16px/1.5 "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      min-height: 100vh;
    }
    .wrap {
      max-width: 1120px;
      margin: 0 auto;
      padding: 48px 24px 72px;
      display: grid;
      gap: 28px;
    }
    h1,
    h2 {
      margin: 0;
    }
    h1 {
      font-size: clamp(26px, 3vw, 32px);
      font-weight: 700;
      letter-spacing: -0.4px;
    }
    h2 {
      font-size: 18px;
      color: var(--sub);
      font-weight: 500;
    }
    .grid {
      display: grid;
      gap: 28px;
    }
    @media (min-width: 960px) {
      .grid {
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        align-items: start;
      }
    }
    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 28px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(6px);
    }
    label {
      display: block;
      font-size: 13px;
      color: var(--sub);
      margin-bottom: 6px;
      font-weight: 500;
      letter-spacing: 0.2px;
    }
    input,
    textarea,
    select {
      width: 100%;
      background: var(--surface-soft);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      outline: none;
      font: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }
    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      background: #ffffff;
      box-shadow: 0 0 0 4px var(--accent-soft);
    }
    textarea {
      min-height: 96px;
      resize: vertical;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .photo-field {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 16px;
    }
    .photo-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .photo-preview {
      width: 96px;
      height: 96px;
      border-radius: 18px;
      object-fit: cover;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      background: var(--surface-soft);
    }
    .photo-status.error {
      color: #d12c2c;
    }
    .candidate-photo {
      width: 100%;
      max-width: 180px;
      border-radius: 20px;
      object-fit: cover;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      margin: 0 auto 16px;
      display: block;
      background: var(--surface-soft);
    }
    .btn {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border-radius: 14px;
      border: 1px solid transparent;
      padding: 12px 16px;
      font-weight: 600;
      transition: transform 0.16s ease, box-shadow 0.2s ease, background 0.2s ease;
      font: inherit;
    }
    .btn.acc {
      background: linear-gradient(135deg, #0a84ff, #1b95ff);
      color: #ffffff;
      box-shadow: var(--shadow-soft);
    }
    .btn.acc:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 32px rgba(10, 132, 255, 0.25);
    }
    .btn.ghost {
      background: var(--surface-soft);
      border-color: var(--border);
      color: var(--text);
    }
    .btn.ghost:hover {
      background: rgba(0, 0, 0, 0.06);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .center {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .stack {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .pill {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tag {
      font-size: 13px;
      background: var(--accent-soft);
      border: 1px solid rgba(10, 132, 255, 0.24);
      padding: 6px 12px;
      border-radius: 999px;
      color: var(--accent);
      font-weight: 500;
    }
    .muted {
      color: var(--sub);
    }
    .spacer {
      height: 6px;
    }
    hr {
      border: none;
      height: 1px;
      background: rgba(0, 0, 0, 0.08);
      margin: 18px 0;
    }
    #status {
      font-size: 13px;
      color: var(--sub);
    }
    .swipe-card {
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 22px;
      background: linear-gradient(135deg, rgba(10, 132, 255, 0.05), rgba(52, 199, 89, 0.05));
    }
    .who {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.2px;
    }
    .actions {
      display: flex;
      gap: 12px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .actions .btn {
      flex: 1 1 140px;
      min-width: 120px;
    }
    .col {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .matches {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .matches .item {
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--surface);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
    }
    .match-item {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    .match-body {
      flex: 1;
    }
    .match-photo {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      object-fit: cover;
      border: 1px solid var(--border);
      background: var(--surface-soft);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
      flex-shrink: 0;
    }
    .match-photo.placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--sub);
      background: var(--surface-soft);
    }
    .small {
      font-size: 12px;
    }
    .right {
      float: right;
    }
    .hidden {
      display: none !important;
    }

    .credits {
      text-align: center;
      padding: 24px;
      font-size: 13px;
      color: var(--sub);
    }

    .credits a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }

    .credits a:hover {
      text-decoration: underline;
    }

    @media (max-width: 720px) {
      body {
        background: var(--bg);
      }
      .wrap {
        padding: 32px 18px 56px;
      }
      .card {
        padding: 24px;
        border-radius: 18px;
      }
      .actions {
        gap: 10px;
      }
      .actions .btn {
        flex: 1 1 100px;
      }
      .row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap grid">
    <!-- LEFT: Profile / Swipe -->
    <div class="stack">
      <div class="card" id="screen-profile">
        <h1>Yoobee Connect</h1>
        <h2>Create your profile (one-time)</h2>
        <div class="spacer"></div>
        <div class="row">
          <div>
            <label>Name</label>
            <input id="name" placeholder="e.g., Kauri H. (A7)" required />
          </div>
          <div>
            <label>Campus</label>
            <select id="campus" required>
              <option value="">Select campus…</option>
              <option>Auckland1</option>
              <option>Auckland2</option>
              <option>Auckland3</option>
              <option>Christchurch</option>
            </select>
          </div>
          <div>
            <label>Gender</label>
            <select id="gender" required>
              <option value="">Select gender…</option>
              <option>Female</option>
              <option>Male</option>
              <option>Non-binary</option>
              <option>Prefer not to say</option>
              <option>Other</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Country</label>
            <select id="country" required><option value="">Select country…</option></select>
          </div>
          <div>
            <label>Background</label>
            <input id="background" placeholder="e.g., Computer Science" required />
          </div>
        </div>
        <div>
          <label>Interests (comma separated)</label>
          <textarea id="interests" placeholder="e.g., AI, Robotics, Cloud" required></textarea>
        </div>
        <div>
          <label>Hobbies (comma separated)</label>
          <textarea id="hobbies" placeholder="e.g., Trail running, Indie films" required></textarea>
        </div>
        <div>
          <label>Contact email</label>
          <input id="contact" type="email" placeholder="yourname@yoobee.ac.nz" autocomplete="email" required />
        </div>
        <div>
          <label>Profile photo</label>
          <div class="photo-field">
            <img id="photo-preview" class="photo-preview hidden" alt="Profile preview" />
            <div class="photo-controls">
              <input id="photo" type="file" accept="image/*" />
              <div id="photo-status" class="small muted photo-status"></div>
              <div class="small muted">We compress your image (max 512px, ~150 KB) before saving it.</div>
            </div>
          </div>
        </div>
        <div class="row">
          <button class="btn acc" id="btn-register">Save & Start</button>
          <button class="btn ghost" id="btn-restore">I already have a code</button>
        </div>
        <div id="status" class="spacer"></div>
      </div>

      <div class="card hidden" id="screen-swipe">
        <div>
          <b>Welcome, <span id="me-name">—</span></b>
          <span class="small muted right">Code: <span id="me-code">—</span></span>
        </div>
        <hr/>
        <div class="swipe-card" id="candidate-card">
          <div id="candidate-empty" class="center">
            <div class="muted">No more candidates right now. We’ll keep checking for new matches…</div>
          </div>
          <div id="candidate" class="hidden">
            <img id="c-photo" class="candidate-photo hidden" alt="Candidate photo" />
            <div class="who"><span id="c-name">—</span></div>
            <div class="small muted" id="c-meta">—</div>
            <div class="pill" id="c-tags"></div>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="btn-left">👎 Pass</button>
          <button class="btn acc" id="btn-right">👍 Connect</button>
          <button class="btn ghost" id="btn-refresh">↻ Refresh matches</button>
        </div>
        <div class="row">
          <button class="btn ghost" id="btn-logout">Sign out</button>
          <div id="status2" class="small muted center"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Matches -->
    <div class="card col">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Your Matches</h2>
        <div class="small muted" id="last-sync">Last sync: —</div>
      </div>
      <div id="matches" class="matches"></div>
    </div>
  </div>

  <footer class="credits">
    © 2025 Developed by
    <a href="https://www.instagram.com/yasassri.me" target="_blank" rel="noopener noreferrer">Yasas Sri Wickramasinghe</a>.
  </footer>

<script>
/* ==========================
   CONFIG
========================== */
const BASE_URL = 'https://script.google.com/macros/s/AKfycbyGjR1PbKzZ1zv571z1Mo9LxK0Jr8Ck5uxx726wrChoXcL11wZ6Falf2VXJEM4RiLKi/exec';

/* ==========================
   STATE
========================== */
let joinCode = null;
let meProfile = null;
let deck = [];           // candidate queue
let swiped = new Set();  // in-session memory
let matchList = [];      // [{ts, partner:{...}}]
let current = null;
let draftPhoto = null;   // base64 data URL awaiting upload

// polling
let matchPollTimer = null;
const MATCH_POLL_MS = 15000;

const PHOTO_MAX_DIM = 512;
// Google Sheets cells cap out at 50k characters, so we keep the encoded photo
// safely below that (≈35 KB once decoded).
const PHOTO_MAX_BYTES = 36 * 1024;
const PHOTO_MAX_CHAR_LENGTH = 48000;

/* ==========================
   DOM helpers
========================== */
const el = id => document.getElementById(id);
const show = id => el(id).classList.remove('hidden');
const hide = id => el(id).classList.add('hidden');
const normalizeCode = code => (code || '').toString().trim().toUpperCase();
const normalizeCandidate = cand => {
  if(!cand || typeof cand !== 'object') return null;
  const code = normalizeCode(cand.code || cand.id || '');
  if(!code) return null;
  const normalized = { ...cand, code };
  const rawPhoto = normalized.photo || normalized.avatar || normalized.image || '';
  const safePhoto = normalizePhotoData(rawPhoto);
  if(safePhoto){
    normalized.photo = safePhoto;
  }else{
    delete normalized.photo;
  }
  return normalized;
};
const isValidEmail = email => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
const COUNTRY_LIST = [
  'Afghanistan','Albania','Algeria','Andorra','Angola','Antigua and Barbuda','Argentina','Armenia','Australia','Austria',
  'Azerbaijan','Bahamas','Bahrain','Bangladesh','Barbados','Belarus','Belgium','Belize','Benin','Bhutan','Bolivia',
  'Bosnia and Herzegovina','Botswana','Brazil','Brunei','Bulgaria','Burkina Faso','Burundi','Cambodia','Cameroon','Canada',
  'Cape Verde','Central African Republic','Chad','Chile','China','Colombia','Comoros','Congo (Republic)','Congo (DRC)',
  'Costa Rica','Côte d\'Ivoire','Croatia','Cuba','Cyprus','Czech Republic','Denmark','Djibouti','Dominica','Dominican Republic','Ecuador',
  'Egypt','El Salvador','Equatorial Guinea','Eritrea','Estonia','Eswatini','Ethiopia','Fiji','Finland','France','Gabon',
  'Gambia','Georgia','Germany','Ghana','Greece','Grenada','Guatemala','Guinea','Guinea-Bissau','Guyana','Haiti','Honduras',
  'Hungary','Iceland','India','Indonesia','Iran','Iraq','Ireland','Israel','Italy','Jamaica','Japan','Jordan','Kazakhstan',
  'Kenya','Kiribati','Kuwait','Kyrgyzstan','Laos','Latvia','Lebanon','Lesotho','Liberia','Libya','Liechtenstein',
  'Lithuania','Luxembourg','Madagascar','Malawi','Malaysia','Maldives','Mali','Malta','Marshall Islands','Mauritania',
  'Mauritius','Mexico','Micronesia','Moldova','Monaco','Mongolia','Montenegro','Morocco','Mozambique','Myanmar','Namibia',
  'Nauru','Nepal','Netherlands','New Zealand','Nicaragua','Niger','Nigeria','North Korea','North Macedonia','Norway','Oman',
  'Pakistan','Palestine','Palau','Panama','Papua New Guinea','Paraguay','Peru','Philippines','Poland','Portugal','Qatar','Romania',
  'Russia','Rwanda','Saint Kitts and Nevis','Saint Lucia','Saint Vincent and the Grenadines','Samoa','San Marino',
  'Sao Tome and Principe','Saudi Arabia','Senegal','Serbia','Seychelles','Sierra Leone','Singapore','Slovakia','Slovenia',
  'Solomon Islands','Somalia','South Africa','South Korea','South Sudan','Spain','Sri Lanka','Sudan','Suriname','Sweden',
  'Switzerland','Syria','Taiwan','Tajikistan','Tanzania','Thailand','Timor-Leste','Togo','Tonga','Trinidad and Tobago',
  'Tunisia','Turkey','Turkmenistan','Tuvalu','Uganda','Ukraine','United Arab Emirates','United Kingdom','United States',
  'Uruguay','Uzbekistan','Vanuatu','Vatican City','Venezuela','Vietnam','Yemen','Zambia','Zimbabwe'
];

function normalizePhotoData(data){
  if(typeof data !== 'string') return '';
  const trimmed = data.trim();
  if(!/^data:image\/(png|jpe?g|webp);base64,/i.test(trimmed)) return '';
  if(trimmed.length > PHOTO_MAX_CHAR_LENGTH) return '';
  return trimmed;
}

function estimateBase64Bytes(dataUrl){
  if(!dataUrl) return 0;
  const comma = dataUrl.indexOf(',');
  const base64 = (comma >= 0 ? dataUrl.slice(comma + 1) : dataUrl).replace(/\s+/g, '');
  if(!base64.length) return 0;
  const padding = (base64.match(/=+$/) || [''])[0].length;
  return Math.max(0, Math.ceil((base64.length * 3) / 4) - padding);
}

function fileToDataUrl(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error('Unable to read file'));
    reader.readAsDataURL(file);
  });
}

function loadImageFromDataUrl(dataUrl){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = () => reject(new Error('Unable to decode image'));
    img.src = dataUrl;
  });
}

async function compressImageFile(file){
  const dataUrl = await fileToDataUrl(file);
  const img = await loadImageFromDataUrl(dataUrl);
  const canvas = document.createElement('canvas');
  const maxSide = Math.max(img.width || 1, img.height || 1);
  const scale = maxSide > PHOTO_MAX_DIM ? PHOTO_MAX_DIM / maxSide : 1;
  const width = Math.max(1, Math.round((img.width || 1) * scale));
  const height = Math.max(1, Math.round((img.height || 1) * scale));
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, width, height);
  ctx.drawImage(img, 0, 0, width, height);
  let quality = 0.82;
  let output = canvas.toDataURL('image/jpeg', quality);
  const fitsLimits = data => data.length <= PHOTO_MAX_CHAR_LENGTH && estimateBase64Bytes(data) <= PHOTO_MAX_BYTES;
  for(let i=0;i<8 && !fitsLimits(output);i++){
    quality = Math.max(0.32, quality - 0.1);
    output = canvas.toDataURL('image/jpeg', quality);
  }
  if(!fitsLimits(output)){
    throw new Error('Photo is too large even after compression. Please choose an image under 35 KB.');
  }
  return output;
}

function setPhotoPreview(data){
  const preview = el('photo-preview');
  if(!preview) return;
  const normalized = normalizePhotoData(data || '');
  if(normalized){
    preview.src = normalized;
    preview.classList.remove('hidden');
  }else{
    preview.src = '';
    preview.classList.add('hidden');
  }
}

function setPhotoStatus(msg='', isError=false){
  const node = el('photo-status');
  if(!node) return;
  node.textContent = msg || '';
  node.classList.toggle('error', !!isError);
}

function applyProfilePhoto(profile){
  if(!profile || typeof profile !== 'object') return;
  const safe = normalizePhotoData(profile.photo || '');
  if(safe){
    profile.photo = safe;
  }else{
    delete profile.photo;
  }
}

function refreshPhotoPreview(){
  const source = draftPhoto || (meProfile && meProfile.photo) || '';
  setPhotoPreview(source);
}

async function getPhotoDataForSubmit(){
  const input = el('photo');
  if(input && input.files && input.files[0]){
    if(draftPhoto){
      return normalizePhotoData(draftPhoto) || '';
    }
    const file = input.files[0];
    if(!file.type || !file.type.startsWith('image/')){
      throw new Error('Please choose an image file for your profile photo.');
    }
    setPhotoStatus('Optimising photo…');
    const compressed = await compressImageFile(file);
    const normalized = normalizePhotoData(compressed);
    if(!normalized){
      throw new Error('Unable to prepare that photo. Try a different image.');
    }
    draftPhoto = normalized;
    refreshPhotoPreview();
    setPhotoStatus('Photo ready to upload.');
    return normalized;
  }
  if(draftPhoto){
    return normalizePhotoData(draftPhoto) || '';
  }
  if(meProfile && meProfile.photo){
    return normalizePhotoData(meProfile.photo) || '';
  }
  return '';
}
function setStatus(msg, where='status'){ el(where).textContent = msg || ''; }
function populateCountrySelect(selected=''){
  const select = el('country');
  if(!select) return;
  const chosen = selected || select.value || '';
  select.innerHTML = '';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = 'Select country…';
  placeholder.disabled = true;
  if(!chosen) placeholder.selected = true;
  select.appendChild(placeholder);
  COUNTRY_LIST.forEach(country => {
    const opt = document.createElement('option');
    opt.value = country;
    opt.textContent = country;
    if(country === chosen) opt.selected = true;
    select.appendChild(opt);
  });
}
function populateProfileFormFromState(){
  const profile = meProfile || {};
  applyProfilePhoto(profile);
  const nameField = el('name');
  if(nameField){ nameField.value = profile.name || ''; }
  const campusField = el('campus');
  if(campusField){ campusField.value = profile.campus || ''; }
  const genderField = el('gender');
  if(genderField){ genderField.value = profile.gender || ''; }
  populateCountrySelect(profile.country || '');
  const backgroundField = el('background');
  if(backgroundField){ backgroundField.value = profile.background || ''; }
  const interestsField = el('interests');
  if(interestsField){
    if(Array.isArray(profile.interests)){
      interestsField.value = profile.interests.join(', ');
    }else{
      interestsField.value = profile.interests || '';
    }
  }
  const hobbiesField = el('hobbies');
  if(hobbiesField){
    if(Array.isArray(profile.hobbies)){
      hobbiesField.value = profile.hobbies.join(', ');
    }else{
      hobbiesField.value = profile.hobbies || '';
    }
  }
  const contactField = el('contact');
  if(contactField){
    contactField.value = profile.teams || profile.contact || '';
  }
  const photoInput = el('photo');
  if(photoInput){ photoInput.value = ''; }
  if(!draftPhoto){
    draftPhoto = '';
  }
  refreshPhotoPreview();
  setPhotoStatus('');
}

/* ==========================
   STORAGE
========================== */
function saveSession(){
  joinCode = normalizeCode(joinCode);
  localStorage.setItem('yc_code', joinCode || '');
  const profileToSave = { ...(meProfile || {}) };
  applyProfilePhoto(profileToSave);
  localStorage.setItem('yc_profile', JSON.stringify(profileToSave));
}
function loadSession(){
  joinCode = normalizeCode(localStorage.getItem('yc_code') || '');
  try{ meProfile = JSON.parse(localStorage.getItem('yc_profile')||'{}'); }catch{ meProfile = {}; }
  if(!meProfile || typeof meProfile !== 'object'){ meProfile = {}; }
  applyProfilePhoto(meProfile);
  draftPhoto = '';
}
function clearSession(){
  localStorage.removeItem('yc_code');
  localStorage.removeItem('yc_profile');
  draftPhoto = '';
}

/* ==========================
   API (no headers => simple request, no preflight)
========================== */
async function apiGet(params){
  const url = new URL(BASE_URL);
  Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, v));
  const r = await fetch(url.toString(), { method:'GET' }); // no headers
  const text = await r.text();
  try { return JSON.parse(text); } catch { throw new Error('Bad JSON: ' + text); }
}

async function apiPost(body){
  // IMPORTANT: no custom headers; string body keeps it a "simple" request (no OPTIONS)
  let r;
  try{
    r = await fetch(BASE_URL, { method:'POST', body: JSON.stringify(body) });
  }catch(e){
    throw new Error('Network error: ' + (e && e.message ? e.message : e));
  }
  const text = await r.text();
  try { return JSON.parse(text); }
  catch { throw new Error('Bad JSON from server: ' + text.slice(0,200)); }
}

/* ==========================
   MATCH POLLING
========================== */
function startMatchPolling(){
  stopMatchPolling();
  joinCode = normalizeCode(joinCode);
  if(!joinCode) return;
  const tick = async () => {
    if(document.visibilityState === 'visible' && joinCode){
      try { await syncMatchesFromServer(); } catch(_e){}
    }
  };
  matchPollTimer = setInterval(tick, MATCH_POLL_MS);
  setTimeout(tick, 1000);
}
function stopMatchPolling(){
  if(matchPollTimer){ clearInterval(matchPollTimer); matchPollTimer = null; }
}
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'visible' && joinCode){
    syncMatchesFromServer().catch(()=>{});
  }
});

/* ==========================
   FLOWS
========================== */
async function saveProfile(){
  const name = el('name').value.trim();
  const campus = el('campus').value.trim();
  const gender = el('gender').value.trim();
  const country = el('country').value.trim();
  const background = el('background').value.trim();
  const interests = el('interests').value.trim();
  const hobbies = el('hobbies').value.trim();
  const contactEmail = el('contact').value.trim();
  if(!name || !campus || !gender || !background){
    setStatus('Please fill Name, Campus, Gender, and Background.'); return;
  }
  if(!country || !interests || !hobbies || !contactEmail){
    setStatus('Country, interests, hobbies, and email are required.'); return;
  }
  if(!isValidEmail(contactEmail)){
    setStatus('Please enter a valid email address.'); return;
  }
  const interestList = interests.split(',').map(s => s.trim()).filter(Boolean);
  const hobbyList = hobbies.split(',').map(s => s.trim()).filter(Boolean);
  let photoData = '';
  try{
    photoData = await getPhotoDataForSubmit();
  }catch(e){
    const msg = e && e.message ? e.message : 'Unable to process photo.';
    setPhotoStatus(msg, true);
    setStatus(msg);
    return;
  }
  setStatus('Saving…');
  let res;
  try{
    res = await apiPost({ action:'register', name, campus, gender, country, background, interests, hobbies, teams: contactEmail, photoData });
  }catch(e){
    setStatus('Save failed: ' + e.message);
    return;
  }
  if(!res.ok){ setStatus('Error: ' + res.error); return; }

  joinCode = normalizeCode(res.code);
  meProfile = res.profile||{};
  applyProfilePhoto(meProfile);
  if(meProfile){
    meProfile.country = meProfile.country || country;
    meProfile.interests = Array.isArray(meProfile.interests) && meProfile.interests.length ? meProfile.interests : interestList;
    meProfile.hobbies = Array.isArray(meProfile.hobbies) && meProfile.hobbies.length ? meProfile.hobbies : hobbyList;
    meProfile.teams = meProfile.teams || contactEmail;
    meProfile.gender = meProfile.gender || gender;
    if(!meProfile.photo && photoData){
      meProfile.photo = normalizePhotoData(photoData);
    }
  }
  draftPhoto = '';
  saveSession();
  populateProfileFormFromState();

  el('me-name').textContent = meProfile.name || name;
  el('me-code').textContent = joinCode;
  refreshPhotoPreview();
  setPhotoStatus(meProfile && meProfile.photo ? 'Photo saved.' : '');
  const photoInput = el('photo');
  if(photoInput){ photoInput.value = ''; }
  setStatus('');
  hide('screen-profile'); show('screen-swipe');
  startMatchPolling();
  await fetchCandidates();
  await syncMatchesFromServer(); // hydrate
  await nextCard();
}

async function restore(){
  loadSession();
  const code = normalizeCode(prompt('Enter your join code:', joinCode || ''));
  if(!code){ return; }
  setStatus('Restoring…');
  let res;
  try{
    res = await apiGet({ action:'restore', code });
  }catch(e){
    setStatus('Restore failed: ' + e.message);
    return;
  }
  if(!res.ok){ setStatus('Error: ' + res.error); return; }
  joinCode = code;
  meProfile = res.profile||{};
  applyProfilePhoto(meProfile);
  matchList = Array.isArray(res.matches)? res.matches : [];
  saveSession();
  populateProfileFormFromState();
  draftPhoto = '';
  refreshPhotoPreview();
  setPhotoStatus(meProfile && meProfile.photo ? 'Photo restored.' : '');
  const photoInput = el('photo');
  if(photoInput){ photoInput.value = ''; }
  el('me-name').textContent = meProfile.name || '—';
  el('me-code').textContent = joinCode;
  setStatus('');
  hide('screen-profile'); show('screen-swipe');
  startMatchPolling();
  renderMatches();
  await fetchCandidates();
  await nextCard();
}

function logout(){
  stopMatchPolling();
  clearSession();
  joinCode = null;
  meProfile = {};
  deck = []; swiped.clear(); matchList = []; current=null;
  el('matches').innerHTML = '';
  hide('screen-swipe'); show('screen-profile');
  setStatus('', 'status2');
  populateProfileFormFromState();
}

/* ==========================
   CANDIDATES & SWIPES
========================== */
async function fetchCandidates(){
  const code = normalizeCode(joinCode);
  if(!code) return;
  setStatus('Loading candidates…','status2');
  let res;
  try{
    res = await apiGet({ action:'candidates', code });
  }catch(e){
    setStatus('Candidates failed: ' + e.message, 'status2');
    return;
  }
  if(!res.ok){ setStatus('Error: ' + res.error, 'status2'); return; }
  const myCode = normalizeCode(joinCode);
  const seen = new Set(deck.map(d=> normalizeCode(d.code)));
  const incoming = Array.isArray(res.candidates) ? res.candidates : [];
  incoming
    .map(normalizeCandidate)
    .filter(Boolean)
    .forEach(c=>{
      const code = normalizeCode(c.code);
      if(!code || code === myCode || seen.has(code) || swiped.has(code)) return;
      const interests = Array.isArray(c.interests)
        ? c.interests.slice()
        : (typeof c.interests === 'string' && c.interests.trim()
            ? c.interests.split(/[,;|]/).map(t => t.trim()).filter(Boolean)
            : []);
      seen.add(code);
      deck.push({ ...c, code, interests, gender: c.gender || '' });
    });
  setStatus('', 'status2');
}

async function onSwipe(dir){
  if(!current) return;
  const code = normalizeCode(joinCode);
  if(!code){ setStatus('Missing join code. Please sign in again.','status2'); return; }
  const target = normalizeCode(current.code);
  if(!target){ return; }
  swiped.add(target);
  setStatus('Saving swipe…','status2');
  let res;
  try{
    res = await apiPost({ action:'swipe', code, target, dir });
  }catch(e){
    swiped.delete(target);
    setStatus('Swipe failed: ' + e.message, 'status2');
    return;
  }
  if(!res || !res.ok){
    swiped.delete(target);
    setStatus('Swipe failed: ' + (res && res.error ? res.error : 'Unknown error'), 'status2');
    return;
  }
  setStatus('', 'status2');
  if(res.matched && res.partner){
    recordMatch(res.partner);
  }
  if(Array.isArray(res.matches)){
    applyServerMatches(res.matches);
  }
  await nextCard();
  try { await syncMatchesFromServer(); } catch(_e){}
}

async function nextCard(){
  const matchedCodes = new Set(
    matchList
      .map(m=> normalizeCode(m && m.partner ? (m.partner.code || m.partner.id || '') : ''))
      .filter(Boolean)
  );
  let next = null;
  while(deck.length){
    const c = normalizeCandidate(deck.shift());
    if(!c) continue;
    if(normalizeCode(c.code) === normalizeCode(joinCode)) continue;
    if(swiped.has(c.code) || swiped.has(normalizeCode(c.code))) continue;
    if(matchedCodes.has(c.code)) continue;
    next = c; break;
  }
  current = next;
  renderCandidate();
  if(!current){
    await fetchCandidates();
    if(deck.length){ return nextCard(); }
  }
}

/* ==========================
   RENDER
========================== */
function renderCandidate(){
  const empty = el('candidate-empty');
  const block = el('candidate');
  if(!current){
    show('candidate-empty'); hide('candidate');
    el('c-name').textContent = '';
    el('c-meta').textContent = '';
    el('c-tags').innerHTML = '';
    return;
  }
  hide('candidate-empty'); show('candidate');
  const photoEl = el('c-photo');
  if(photoEl){
    const photo = normalizePhotoData(current.photo || '');
    if(photo){
      photoEl.src = photo;
      photoEl.classList.remove('hidden');
    }else{
      photoEl.src = '';
      photoEl.classList.add('hidden');
    }
  }
  el('c-name').textContent = current.name || '(No name)';
  const genderMeta = current.gender ? ` • ${current.gender}` : '';
  el('c-meta').textContent = `${current.campus||'—'} • ${current.country||'—'} • ${current.background||'—'}${genderMeta}`;
  el('c-tags').innerHTML = (current.interests||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('') || '<span class="muted small">No interests listed</span>';
}

function renderMatches(){
  const box = el('matches');
  box.innerHTML = '';
  if(!matchList.length){
    box.innerHTML = '<div class="muted small">No matches yet.</div>';
    return;
  }
  matchList.forEach(m=>{
    const p = m.partner || {};
    const when = m.ts ? new Date(m.ts).toLocaleString() : '';
    const tags = (p.interests||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('');
    const contactValue = p.teams || p.contact || '';
    const contactLine = contactValue ? `<div class="small">Email: <b>${escapeHtml(contactValue)}</b></div>` : '';
    const codeSpan = p.code ? `<div class="small muted">Code: ${escapeHtml(normalizeCode(p.code))}</div>` : '';
    const genderLine = p.gender ? `<div class="small">Gender: <b>${escapeHtml(p.gender)}</b></div>` : '';
    const photo = normalizePhotoData(p.photo || '');
    const safeName = p.name || 'Unknown';
    const initials = safeName.trim().charAt(0).toUpperCase() || '🤝';
    const photoHtml = photo
      ? `<img class="match-photo" src="${escapeHtml(photo)}" alt="${escapeHtml(safeName)}" />`
      : `<div class="match-photo placeholder">${escapeHtml(initials)}</div>`;
    box.insertAdjacentHTML('beforeend', `
      <div class="item match-item">
        ${photoHtml}
        <div class="match-body">
          <div><b>${escapeHtml(safeName)}</b></div>
          <div class="small muted">${escapeHtml(p.campus||'—')} • ${escapeHtml(p.country||'—')} • ${escapeHtml(p.background||'—')}</div>
          ${genderLine}
          <div class="pill" style="margin-top:6px">${tags||'<span class="small muted">No interests</span>'}</div>
          ${contactLine}
          ${codeSpan}
          <div class="small muted" style="margin-top:6px">Matched: ${escapeHtml(when)}</div>
        </div>
      </div>
    `);
  });
}

/* ==========================
   MATCH SYNC
========================== */
function recordMatch(partner){
  const ts = Date.now();
  const partnerCode = normalizeCode(partner && (partner.code || partner.id || ''));
  const myCode = normalizeCode(joinCode);
  if(!partnerCode || (myCode && partnerCode === myCode)) return;
  const partnerInterests = partner && partner.interests;
  const partnerHobbies = partner && partner.hobbies;
  const norm = {
    ts,
    partner: {
      code: partnerCode,
      name: partner && partner.name ? partner.name : '',
      campus: partner && partner.campus ? partner.campus : '',
      country: partner && partner.country ? partner.country : '',
      background: partner && partner.background ? partner.background : '',
      gender: partner && partner.gender ? partner.gender : '',
      interests: Array.isArray(partnerInterests)
        ? partnerInterests.slice()
        : (typeof partnerInterests === 'string' && partnerInterests.trim()
            ? partnerInterests.split(/[,;|]/).map(t => t.trim()).filter(Boolean)
            : []),
      hobbies: Array.isArray(partnerHobbies)
        ? partnerHobbies.slice()
        : (typeof partnerHobbies === 'string' && partnerHobbies.trim()
            ? partnerHobbies.split(/[,;|]/).map(h => h.trim()).filter(Boolean)
            : []),
      teams: partner && partner.teams ? partner.teams : (partner && partner.contact ? partner.contact : ''),
      photo: normalizePhotoData(partner && partner.photo ? partner.photo : '')
    }
  };
  const seen = new Set(
    matchList
      .map(m => normalizeCode(m && m.partner ? (m.partner.code || m.partner.id || '') : ''))
      .filter(Boolean)
  );
  if(!seen.has(partnerCode)){ matchList.unshift(norm); }
  renderMatches();
}

function applyServerMatches(serverMatches){
  if(!Array.isArray(serverMatches)) return;
  const myCode = normalizeCode(joinCode);
  const normalized = serverMatches
    .map(entry => {
      const partner = entry && entry.partner ? entry.partner : {};
      const code = normalizeCode(partner.code || partner.id || '');
      if(!code || (myCode && code === myCode)) return null;
      const partnerInterests = partner.interests;
      const partnerHobbies = partner.hobbies;
      const normalizedPartner = {
        ...partner,
        code,
        gender: partner.gender || '',
        teams: partner.teams || partner.contact || '',
        interests: Array.isArray(partnerInterests)
          ? partnerInterests.slice()
          : (typeof partnerInterests === 'string' && partnerInterests.trim()
              ? partnerInterests.split(/[,;|]/).map(t => t.trim()).filter(Boolean)
              : []),
        hobbies: Array.isArray(partnerHobbies)
          ? partnerHobbies.slice()
          : (typeof partnerHobbies === 'string' && partnerHobbies.trim()
              ? partnerHobbies.split(/[,;|]/).map(t => t.trim()).filter(Boolean)
              : [])
      };
      const safePhoto = normalizePhotoData(partner.photo || '');
      if(safePhoto){
        normalizedPartner.photo = safePhoto;
      }else{
        delete normalizedPartner.photo;
      }
      return {
        ts: typeof entry.ts === 'number' ? entry.ts : Date.parse(entry.ts) || Date.now(),
        partner: normalizedPartner
      };
    })
    .filter(Boolean);
  const seen = new Set();
  const deduped = [];
  normalized.forEach(item => {
    const code = item.partner.code;
    if(seen.has(code)) return;
    seen.add(code);
    deduped.push(item);
  });
  matchList = deduped.sort((a,b)=> (b.ts||0)-(a.ts||0));
  renderMatches();
}

async function syncMatchesFromServer(){
  const code = normalizeCode(joinCode);
  if(!code) return;
  const res = await apiGet({ action:'matches', code });
  if(!res.ok) return;
  applyServerMatches(res.matches||[]);
  el('last-sync').textContent = 'Last sync: ' + new Date().toLocaleTimeString();
}

/* ==========================
   UTIL
========================== */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ==========================
   WIRE UP
========================== */
el('btn-register').addEventListener('click', saveProfile);
el('btn-restore').addEventListener('click', restore);
el('btn-logout').addEventListener('click', logout);
el('btn-left').addEventListener('click', ()=> onSwipe('left'));
el('btn-right').addEventListener('click', ()=> onSwipe('right'));
el('btn-refresh').addEventListener('click', ()=> syncMatchesFromServer());
const photoInputControl = el('photo');
if(photoInputControl){
  photoInputControl.addEventListener('change', async ()=>{
    if(!photoInputControl.files || !photoInputControl.files.length){
      draftPhoto = '';
      refreshPhotoPreview();
      setPhotoStatus(meProfile && meProfile.photo ? 'Photo on file.' : '');
      return;
    }
    try{
      await getPhotoDataForSubmit();
    }catch(e){
      const msg = e && e.message ? e.message : 'Unable to process photo.';
      setPhotoStatus(msg, true);
      draftPhoto = '';
      refreshPhotoPreview();
      photoInputControl.value = '';
    }
  });
}

window.addEventListener('load', async ()=>{
  loadSession();
  populateProfileFormFromState();
  if(joinCode){
    try{
      const res = await apiGet({ action:'restore', code: joinCode });
      if(res.ok){
        meProfile = res.profile||{};
        applyProfilePhoto(meProfile);
        draftPhoto = '';
        refreshPhotoPreview();
        setPhotoStatus(meProfile && meProfile.photo ? 'Photo restored.' : '');
        const photoInput = el('photo');
        if(photoInput){ photoInput.value = ''; }
        matchList = res.matches||[];
        el('me-name').textContent = meProfile.name || '—';
        el('me-code').textContent = joinCode;
        hide('screen-profile'); show('screen-swipe');
        startMatchPolling();
        renderMatches();
        await fetchCandidates();
        await nextCard();
        return;
      }
    }catch(_e){}
  }
  hide('screen-swipe'); show('screen-profile');
});

// --- Countries dropdown population (injected) ---
const COUNTRIES = [
  "New Zealand","Australia","India","Sri Lanka","Philippines","China","Japan","South Korea","Malaysia",
  "Singapore","Thailand","Vietnam","Nepal","Pakistan","Bangladesh","United Kingdom","United States",
  "Canada","Brazil","Germany","France","Italy","Spain","South Africa","Nigeria","Kenya","Fiji","Indonesia","Taiwan","Hong Kong"
];

function populateCountries(){
  const sel = document.getElementById('country');
  if(!sel) return;
  const existing = Array.from(sel.options).map(o=>o.value);
  const frag = document.createDocumentFragment();
  COUNTRIES.forEach(c=>{
    if(!existing.includes(c)){
      const o = document.createElement('option');
      o.value = c; o.textContent = c;
      frag.appendChild(o);
    }
  });
  sel.appendChild(frag);
}

window.addEventListener('load', populateCountries);

</script>
</body>
</html>

